<!-- Full working corrected RetainX dashboard with all new updates -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RetainX Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
html, body { height: 100%; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: #f4f6f9; }
.navbar { background-color: #1d3557; }
.navbar-brand { color: #fff !important; }
.content { display: flex; height: calc(100vh - 70px); }
.left-panel { width: 80%; padding: 20px; overflow-y: auto; }
.right-panel { width: 20%; background: #ffffff; padding: 20px; border-left: 1px solid #ddd; overflow-y: auto; }
.table-responsive { margin-top: 20px; }
.table-hover tbody tr:hover { background-color: #e3f2fd; }
.footer { background-color: #1d3557; color: #ffffff; text-align: center; padding: 10px; }
.file-name { margin-top: 8px; font-size: 0.9rem; color: #555; }
input[type=file]::-webkit-file-upload-button { visibility: hidden; }
input[type=file]::before { content: 'Choose CSV File'; display: inline-block; background: #1d3557; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
[data-bs-toggle="tooltip"] { cursor: pointer; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
<div class="container-fluid">
  <a class="navbar-brand" href="#">RetainX</a>
</div>
</nav>

<div class="content">
<div class="left-panel">
  <div class="row g-2 align-items-end">
    <div class="col-md-3">
      <a href="sample_customer_retention_full.csv" download class="text-primary">Sample CSV File (Download)</a>
      <input type="file" id="csvFileInput" class="form-control mt-1" accept=".csv">
      <div id="fileName" class="file-name"></div>
    </div>
    <div class="col-md-2">
      <label>Search Customer ID:</label>
      <input type="text" id="searchInput" class="form-control" placeholder="Search...">
    </div>
    <div class="col-md-2">
      <label>Filter by Churn Risk:</label>
      <select id="riskFilter" class="form-control">
        <option value="All">All</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
      </select>
    </div>
    <div class="col-md-3">
      <label>All Use Cases:</label>
      <select id="useCaseFilter" class="form-control">
        <option value="All">All Use Cases</option>
        <option value="Churn">Churn Risk</option>
        <option value="Recommended">Recommended Product</option>
        <option value="Loyalty">Loyalty Points & Tier</option>
        <option value="Reminder">Reminder Message</option>
        <option value="Automation">Planning Automation</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-success w-100" id="exportButton">Export Data</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover mt-4">
      <thead class="table-dark" id="tableHead">
      </thead>
      <tbody id="customerTableBody"></tbody>
    </table>
  </div>
</div>

<div class="right-panel text-center">
  <div class="card mb-3 p-2 shadow-sm">
    <h5>Total Customers</h5>
    <h2 id="totalCustomers">0</h2>
  </div>
  <h6 class="mt-4">Churn Risk Split</h6>
  <canvas id="churnPieChart" style="height:180px; width:180px;"></canvas>
</div>
</div>

<footer class="footer">
© 2025 Rolin Technologies – Powered by RetainX
</footer>

<script>
let customersData = [];

// Upload and Parse CSV
const csvInput = document.getElementById('csvFileInput');
csvInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById('fileName').innerText = `Selected: ${file.name}`;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const today = new Date();
      customersData = results.data.map(cust => {
        const dates = (cust['Purchase Dates'] || '').split(',').map(d => new Date(d.trim())).filter(d => !isNaN(d));
        const lastPurchaseDate = dates.length ? dates.sort((a, b) => b - a)[0] : null;
        const daysSinceLastPurchase = lastPurchaseDate ? Math.floor((today - lastPurchaseDate) / (1000 * 3600 * 24)) : 0;
        const orderFrequency = dates.length;
        const totalSpend = parseFloat(cust['Total Spend']) || 0;

        const loyaltyPoints = Math.floor(totalSpend / 100);
        let loyaltyTier = 'Bronze';
        if (loyaltyPoints >= 300) loyaltyTier = 'Gold';
        else if (loyaltyPoints >= 100) loyaltyTier = 'Silver';

        const productList = (cust['Purchased Products'] || '').split(',').map(p => p.trim());
        const recommendedProduct = productList.length ? productList[productList.length - 1] : '-';

        const reminderMessage = daysSinceLastPurchase <= 30 ? 'No Reminder' : daysSinceLastPurchase <= 60 ? 'Mild Reminder' : 'Urgent Reminder';

        const rScore = daysSinceLastPurchase <= 30 ? 5 : daysSinceLastPurchase <= 60 ? 4 : daysSinceLastPurchase <= 90 ? 3 : daysSinceLastPurchase <= 120 ? 2 : 1;
        const fScore = orderFrequency >= 10 ? 5 : orderFrequency >= 7 ? 4 : orderFrequency >= 4 ? 3 : orderFrequency >= 2 ? 2 : 1;
        const mScore = totalSpend >= 10000 ? 5 : totalSpend >= 5000 ? 4 : totalSpend >= 2000 ? 3 : totalSpend >= 1000 ? 2 : 1;
        const totalRFM = rScore + fScore + mScore;
        const churnRisk = totalRFM >= 11 ? 'Low' : totalRFM >= 7 ? 'Medium' : 'High';

        return {
          customerId: cust['Customer ID'] || '',
          lastPurchaseDate: lastPurchaseDate ? lastPurchaseDate.toISOString().split('T')[0] : '',
          orderFrequency,
          totalSpend,
          daysSinceLastPurchase,
          loyaltyPoints,
          loyaltyTier,
          reminderMessage,
          churnRisk,
          recommendedProduct,
          fullProducts: cust['Purchased Products'] || ''
        }
      });
      renderTable();
      updateDashboard();
      updatePieChart();
    }
  });
});

// Render Table
function renderTable() {
  const riskValue = document.getElementById('riskFilter').value;
  const search = document.getElementById('searchInput').value.toLowerCase();
  const useCase = document.getElementById('useCaseFilter').value;

  const tbody = document.getElementById('customerTableBody');
  const thead = document.getElementById('tableHead');

  let displayColumns = [];
  if (useCase === 'All') displayColumns = ['Customer ID','Last Purchase Date','Order Frequency','Total Spend','Days Since Last Purchase','Churn Risk','Loyalty Points','Loyalty Tier','Reminder Message','Recommended Product'];
  else if (useCase === 'Churn') displayColumns = ['Customer ID','Last Purchase Date','Days Since Last Purchase','Churn Risk'];
  else if (useCase === 'Recommended') displayColumns = ['Customer ID','Recommended Product'];
  else if (useCase === 'Loyalty') displayColumns = ['Customer ID','Loyalty Points','Loyalty Tier'];
  else if (useCase === 'Reminder') displayColumns = ['Customer ID','Reminder Message'];
  else if (useCase === 'Automation') displayColumns = ['Customer ID','Reminder Message','Recommended Product'];

  thead.innerHTML = `<tr>${displayColumns.map(col => `<th>${col}</th>`).join('')}</tr>`;

  tbody.innerHTML = '';
  customersData.forEach(c => {
    if (riskValue !== 'All' && c.churnRisk !== riskValue) return;
    if (search && !c.customerId.toLowerCase().includes(search)) return;
    const row = document.createElement('tr');
    displayColumns.forEach(col => {
      let val = c[col.replaceAll(' ', '').replace('Date', 'Date').toLowerCase()] || '-';
      if (col === 'Recommended Product') {
        row.innerHTML += `<td data-bs-toggle="tooltip" title="${c.fullProducts}">${val}</td>`;
      } else {
        row.innerHTML += `<td>${val}</td>`;
      }
    });
    tbody.appendChild(row);
  });
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(t => new bootstrap.Tooltip(t));
}

// Update Dashboard
function updateDashboard() {
  document.getElementById('totalCustomers').innerText = customersData.length;
}

// Update Pie Chart
let churnPie;
function updatePieChart() {
  const churnCounts = { Low: 0, Medium: 0, High: 0 };
  customersData.forEach(c => churnCounts[c.churnRisk]++);

  if (churnPie) churnPie.destroy();
  churnPie = new Chart(document.getElementById('churnPieChart'), {
    type: 'pie',
    data: {
      labels: ['Low', 'Medium', 'High'],
      datasets: [{
        data: [churnCounts.Low, churnCounts.Medium, churnCounts.High],
        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
      }]
    }
  });
}

document.getElementById('searchInput').addEventListener('input', renderTable);
document.getElementById('riskFilter').addEventListener('change', renderTable);
document.getElementById('useCaseFilter').addEventListener('change', renderTable);
document.getElementById('exportButton').addEventListener('click', function() {
  const filteredRows = [...document.querySelectorAll('#customerTableBody tr')];
  const csvContent = filteredRows.map(row => [...row.children].map(cell => cell.innerText).join(",")).join("\n");
  const headRow = [...document.querySelectorAll('#tableHead th')].map(th => th.innerText).join(",");
  const csv = `${headRow}\n${csvContent}`;

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.setAttribute('href', URL.createObjectURL(blob));
  link.setAttribute('download', 'retainx_filtered_data.csv');
  link.click();
});
</script>

</body>
</html>
